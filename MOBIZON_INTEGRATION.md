# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Mobizon –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS

## üì± –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: –ó–ê–í–ï–†–®–ï–ù–ê ‚úÖ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Memoir —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ —Å SMS Traffic –Ω–∞ **Mobizon** (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω).

---

## üîß –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è

- **–°–æ–∑–¥–∞–Ω** `backend/app/services/mobizon_service.py`
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å [Mobizon API](https://mobizon.kz/help/api-docs/sms-api) (https://api.mobizon.kz/service)
  - –ú–µ—Ç–æ–¥ `send_sms` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS —á–µ—Ä–µ–∑ `message/sendsmsmessage`
  - –ú–µ—Ç–æ–¥ `check_balance` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ `user/getownbalance`
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (`from` –ø–∞—Ä–∞–º–µ—Ç—Ä)
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ (`SMS_TEST_MODE`)
  - **GET** –∑–∞–ø—Ä–æ—Å—ã —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- **–£–¥–∞–ª–µ–Ω** `backend/app/services/sms_traffic_service.py`
  - –°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å SMS Traffic

- **–û–±–Ω–æ–≤–ª–µ–Ω** `backend/app/core/config.py`
  - –î–æ–±–∞–≤–ª–µ–Ω `MOBIZON_API_KEY`
  - –£–¥–∞–ª–µ–Ω—ã `SMS_TRAFFIC_LOGIN` –∏ `SMS_TRAFFIC_PASSWORD`
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω `SMS_TEST_MODE` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

- **–û–±–Ω–æ–≤–ª–µ–Ω—ã** API endpoints (`backend/app/api/v1/sms_auth.py`)
  - `/send-code` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
  - `/verify-code` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  - `/resend-code` - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

### 2. Flutter –∏–∑–º–µ–Ω–µ–Ω–∏—è

- **–û–±–Ω–æ–≤–ª–µ–Ω** `lib/core/network/auth_interceptor.dart`
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è `/sms-auth/` endpoints (–Ω–µ –¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout –ø—Ä–∏ 401)
  - –ò–∑–º–µ–Ω–µ–Ω redirect —Å `/login` –Ω–∞ `/phone-login`

- **–û–±–Ω–æ–≤–ª–µ–Ω** `lib/features/auth/presentation/pages/phone_verify_page.dart`
  - –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
  - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
  - –î–æ–±–∞–≤–ª–µ–Ω `GlobalKey` –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è PIN –ø–æ–ª–µ–π

### 2. Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**backend/.env:**
```bash
# Mobizon (Kazakhstan SMS service)
MOBIZON_API_KEY=kz74ccb480409ac3b6f5ea86ca6954125dc1261de819642334ae0ecc82e69fdf0b42c1
SMS_TEST_MODE=true  # true –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```

---

## üì° Mobizon API (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**–ë–∞–∑–æ–≤—ã–π URL:** `https://api.mobizon.kz/service/`

**–û—Ç–ø—Ä–∞–≤–∫–∞ SMS:**
```
GET https://api.mobizon.kz/service/message/sendsmsmessage
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `apiKey` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –≤–∞—à API –∫–ª—é—á
- `recipient` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –Ω–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ë–ï–ó —Å–∏–º–≤–æ–ª–∞ `+` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `77472367503`)
- `text` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (url-encoded)
- `from` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –ø–æ–¥–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–∞–ª—å—Ñ–∞–∏–º—è, max 11 —Å–∏–º–≤–æ–ª–æ–≤)
- `output` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (`json` –∏–ª–∏ `xml`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `json`)

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "code": 0,  // 0 = —É—Å–ø–µ—Ö, 100 = –≤ —Ñ–æ–Ω–µ, –¥—Ä—É–≥–æ–µ = –æ—à–∏–±–∫–∞
  "data": {
    "messageId": "12345678"
  },
  "message": ""
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞:**
```
GET https://api.mobizon.kz/service/user/getownbalance
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `apiKey` - –≤–∞—à API –∫–ª—é—á
- `output` - —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

**–û—Ç–≤–µ—Ç:**
```json
{
  "code": 0,
  "data": {
    "balance": "4043.0656",
    "currency": "KZT"
  },
  "message": ""
}
```

üìö **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [https://mobizon.kz/help/api-docs/sms-api](https://mobizon.kz/help/api-docs/sms-api)

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (TEST MODE)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ö–æ–≥–¥–∞ `SMS_TEST_MODE=true`:
- SMS –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Mobizon API
- –ö–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏ **–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å**
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ –∏ –∑–∞—Ç—Ä–∞—Ç

### –ü—Ä–∏–º–µ—Ä

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST http://localhost:8000/api/v1/sms-auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "77472367503"}'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "Verification code sent",
  "sms_id": "test-mode-id",
  "expires_in": 300
}
```

**–õ–æ–≥–∏ backend:**
```
üß™ [MOBIZON] TEST MODE - SMS not sent
üìù [MOBIZON] Message: –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Memoir: 598000

–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç.
```

–ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞: **598000** (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ Docker).

---

## üöÄ –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º

### –ù–∞ VPS (194.32.141.227)

1. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VPS:**
   ```bash
   ssh root@194.32.141.227
   ```

2. **–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ–µ–∫—Ç:**
   ```bash
   cd memoir-python
   ```

3. **–û–±–Ω–æ–≤–∏—Ç—å .env:**
   ```bash
   nano backend/.env
   ```
   
   –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:
   ```bash
   MOBIZON_API_KEY=kz74ccb480409ac3b6f5ea86ca6954125dc1261de819642334ae0ecc82e69fdf0b42c1
   SMS_TEST_MODE=false  # –í–ê–ñ–ù–û: false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
   ```

4. **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:**
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   docker logs memoir-python-backend-1 --tail 50
   ```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Mobizon

### –ú–æ–¥–µ—Ä–∞—Ü–∏—è SMS

> "–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ SMS-—Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º —Å–µ—Ä–≤–∏—Å–∞. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –æ—Ç 1 –¥–æ 10 –º–∏–Ω—É—Ç."

**–î–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:**
1. –ó–∞–∫–ª—é—á–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Å Mobizon
2. –°–æ–æ–±—â–∏—Ç—å –°–ª—É–∂–±–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
   - –í–∞—à ID –≤ —Å–∏—Å—Ç–µ–º–µ
   - –¢–µ–º–∞—Ç–∏–∫—É SMS
   - –ü—Ä–∏–º–µ—Ä—ã SMS

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ—Å—Ç–∞–≤–ª—è—Ç—å—Å—è **–≤ —Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–µ–∫—É–Ω–¥—ã**.

### IP-–∞–¥—Ä–µ—Å–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ IP-–∞–¥—Ä–µ—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Mobizon:
- VPS: `194.32.141.227`

–≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.

---

## üîç –û—Ç–ª–∞–¥–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞: "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. API key –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
2. –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–ø–æ–ª–Ω–µ–Ω (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)
3. IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
4. –ü–µ—Ä–≤–æ–µ SMS –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (1-10 –º–∏–Ω—É—Ç)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Mobizon
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ API –¥–æ—Å—Ç—É–ø –≤–∫–ª—é—á–µ–Ω
3. –î–æ–±–∞–≤–∏—Ç—å IP VPS –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
4. –ü–æ–¥–æ–∂–¥–∞—Ç—å –º–æ–¥–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–≤–æ–≥–æ SMS
5. –°–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Mobizon

---

## üìö API Endpoints

### POST /api/v1/sms-auth/send-code

**Request:**
```json
{
  "phone_number": "77472367503"
}
```

**Response (success):**
```json
{
  "success": true,
  "message": "Verification code sent",
  "sms_id": "test-mode-id",
  "expires_in": 300
}
```

### POST /api/v1/sms-auth/verify-code

**Request:**
```json
{
  "phone_number": "77472367503",
  "code": "598000"
}
```

**Response (success):**
```json
{
  "success": true,
  "message": "Phone number verified",
  "access_token": "eyJ0eXAiOiJKV1...",
  "refresh_token": "eyJ0eXAiOiJKV1...",
  "token_type": "bearer"
}
```

### POST /api/v1/sms-auth/resend-code

**Request:**
```json
{
  "phone_number": "77472367503"
}
```

**Response (success):**
```json
{
  "success": true,
  "message": "Verification code resent"
}
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:**
   - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ TEST MODE
   - –ö–æ–¥—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å Docker

2. **–î–µ–ø–ª–æ–π –Ω–∞ VPS:**
   - –í—ã–∫–ª—é—á–∏—Ç—å `SMS_TEST_MODE=false`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å Mobizon
   - –î–æ–∂–¥–∞—Ç—å—Å—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ SMS (1-10 –º–∏–Ω)

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –ó–∞–∫–ª—é—á–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Å Mobizon –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å IP whitelist
   - –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Mobizon.kz](https://mobizon.kz/)
- [API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://mobizon.kz/integration/api)
- [GitHub –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (PHP)](https://github.com/mobizon/mobizon-php)
- [Packagist –ø–∞–∫–µ—Ç](https://packagist.org/packages/mobizon/mobizon-php)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –°–æ–∑–¥–∞–Ω `MobizonService`
- [x] –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π `SMSTrafficService`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [x] –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ TEST MODE
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ VPS —Å `SMS_TEST_MODE=false`
- [ ] –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ Mobizon
- [ ] –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ SMS
- [ ] –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

---

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** üéâ

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏: [Mobizon Support](https://mobizon.kz/support)

